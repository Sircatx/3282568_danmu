<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>æ€ªå°è‘µçš„å¼¹å¹•å½’æ¡£</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        :root { --pink: #ff69b4; --light-pink: #fff0f6; }
        body { font-family: -apple-system, sans-serif; background: #fdf2f5; margin: 0; padding: 15px; }
        .container { max-width: 500px; margin: 0 auto; background: white; border-radius: 24px; padding: 25px; box-shadow: 0 8px 30px rgba(255,105,180,0.1); min-height: 85vh; }
        .header { text-align: center; color: var(--pink); font-size: 1.6rem; font-weight: 800; margin-bottom: 25px; }
        .search-input { width: 100%; padding: 14px; border: 2px solid var(--light-pink); border-radius: 14px; margin-bottom: 20px; box-sizing: border-box; outline: none; }
        .year-title { display: flex; align-items: center; margin: 25px 0 15px; color: var(--pink); font-weight: bold; font-size: 1.1rem; }
        .year-title::after { content: ""; flex: 1; height: 2px; background: linear-gradient(to right, var(--light-pink), transparent); margin-left: 10px; }
        
        .card { display: flex; align-items: center; padding: 18px; background: #fff; border: 1px solid #f0f0f0; border-radius: 18px; cursor: pointer; transition: 0.2s; margin-bottom: 12px; }
        .card:hover { border-color: var(--pink); }
        .card-icon { font-size: 1.8rem; margin-right: 15px; }
        .card-info { flex-grow: 1; display: flex; flex-direction: column; }
        .card-name { font-weight: 700; font-size: 1.1rem; color: #444; }
        .btn-down-ui { padding: 8px 18px; border-radius: 12px; background: var(--pink); color: white; text-decoration: none; font-size: 0.9rem; font-weight: bold; border: none; cursor: pointer; }
        .btn-back { background: #444; color: white; border: none; padding: 10px 20px; border-radius: 12px; margin-bottom: 20px; cursor: pointer; font-weight: bold; }

        /* æ–°å¢ï¼šå†…åµŒå¼å†…å®¹æŸ¥çœ‹å™¨ */
        #viewer-container { display: none; margin-top: 20px; }
        #viewer-content { background: #1a1a1a; color: #ccc; padding: 20px; border-radius: 18px; white-space: pre-wrap; word-wrap: break-word; font-family: monospace; font-size: 0.9rem; line-height: 1.5; max-height: 60vh; overflow-y: auto; border: 1px solid #333; }
        .viewer-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; color: var(--pink); font-weight: bold; }
        .btn-close { background: none; border: 1px solid var(--pink); color: var(--pink); padding: 4px 12px; border-radius: 8px; cursor: pointer; }

        .loading { text-align: center; padding: 50px; color: var(--pink); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">ğŸŒ» æ€ªå°è‘µçš„å¼¹å¹•å½’æ¡£</div>
        <input type="text" id="search" class="search-input" placeholder="ğŸ” æœæ—¥æœŸ(å¦‚20260224)..." oninput="onSearch()">
        
        <div id="viewer-container">
            <div class="viewer-header">
                <span id="viewing-name">æ­£åœ¨é˜…è¯»</span>
                <button class="btn-close" onclick="closeViewer()">æ”¶èµ·å†…å®¹ â†‘</button>
            </div>
            <pre id="viewer-content"></pre>
            <hr style="border: 0; height: 1px; background: var(--light-pink); margin: 20px 0;">
        </div>

        <div id="content"></div>
    </div>

    <script>
        const repo = "Sircatx/3282568_danmu";
        const mirrors = ["https://fastly.jsdelivr.net/gh/", "https://jsd.cdn.zzko.cn/gh/"];
        const content = document.getElementById('content');
        const searchInput = document.getElementById('search');
        const viewerContainer = document.getElementById('viewer-container');
        const viewerContent = document.getElementById('viewer-content');
        const viewingName = document.getElementById('viewing-name');
        
        let homeData = [], currentFiles = [], mode = 'home', currentMonth = '';

        async function loadHome() {
            mode = 'home'; closeViewer();
            content.innerHTML = '<div class="loading">âœ¨ æ­£åœ¨åŒæ­¥æœ€æ–°è®°å½•...</div>';
            try {
                const res = await fetch(`https://api.github.com/repos/${repo}/contents/?t=${Date.now()}`);
                homeData = (await res.json()).filter(i => /^\d{4}-\d{2}$/.test(i.name)).reverse();
                renderHome(homeData);
            } catch (e) { content.innerHTML = '<div class="loading">âš ï¸ è¿æ¥ç¹å¿™ï¼Œè¯·ç¨åå†è¯•</div>'; }
        }

        function renderHome(list) {
            let html = '', lastYear = '';
            list.forEach(item => {
                const year = item.name.split('-')[0];
                if (year !== lastYear) { html += `<div class="year-title">${year} å¹´</div>`; lastYear = year; }
                html += `<div class="card" onclick="loadMonth('${item.name}')">
                    <div class="card-icon">ğŸ“‚</div>
                    <div class="card-info"><span class="card-name">${item.name}</span></div>
                    <span style="color:#eee; font-size:1.2rem">â”</span>
                </div>`;
            });
            content.innerHTML = html;
        }

        async function loadMonth(m, searchKey = '') {
            mode = 'files'; currentMonth = m; closeViewer();
            content.innerHTML = `<button class="btn-back" onclick="loadHome()">â¬… è¿”å›ä¸»é¡µ</button><div class="loading">è¯»å–ä¸­...</div>`;
            try {
                const res = await fetch(`https://api.github.com/repos/${repo}/contents/${m}?t=${Date.now()}`);
                currentFiles = (await res.json()).filter(f => f.name.endsWith('.txt')).reverse();
                renderFiles(searchKey ? currentFiles.filter(f => f.name.replace(/-/g,'').includes(searchKey)) : currentFiles);
            } catch (e) { content.innerHTML = 'è¯»å–å¤±è´¥'; }
        }

        function renderFiles(files) {
            let html = `<button class="btn-back" onclick="loadHome()">â¬… è¿”å›ä¸»é¡µ</button>`;
            files.forEach(f => {
                const fastUrl = `${mirrors[0]}${repo}@main/${currentMonth}/${f.name}`;
                html += `<div class="card" onclick="openInline('${currentMonth}/${f.name}', '${f.name}')">
                    <div class="card-icon">ğŸ“„</div>
                    <div class="card-info"><span class="card-name">${f.name.replace('.txt','')}</span></div>
                    <button class="btn-down-ui" onclick="event.stopPropagation(); forceDownload('${fastUrl}', '${f.name}')">ä¸‹è½½</button>
                </div>`;
            });
            content.innerHTML = html || '<div class="loading">æœªæ‰¾åˆ°æ–‡ä»¶</div>';
        }

        async function openInline(path, name) {
            viewingName.innerText = "æ­£åœ¨åŠ è½½ï¼š" + name.replace('.txt','');
            viewerContent.innerText = "âœ¨ æ­£åœ¨åŠªåŠ›æ‹‰å–æœ€æ–°å¼¹å¹•...";
            viewerContainer.style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // å°è¯•æ‹‰å–å†…å®¹
            let data = null;
            for (let mirror of mirrors) {
                try {
                    const res = await fetch(`${mirror}${repo}@main/${path}?t=${Date.now()}`);
                    if (res.ok) { data = await res.text(); break; }
                } catch (e) {}
            }

            if (data) {
                viewerContent.innerText = data;
            } else {
                viewerContent.innerText = "âŒ è¯»å–å¤±è´¥ï¼Œå¯èƒ½æ˜¯ç”±äºç½‘ç»œæ³¢åŠ¨æˆ–æ–‡ä»¶è¿‡å¤§ã€‚å»ºè®®ç›´æ¥ç‚¹å‡»ä¸‹æ–¹åˆ—è¡¨ä¸­çš„â€œä¸‹è½½â€æŒ‰é’®æŸ¥çœ‹ï¼";
            }
        }

        function closeViewer() { viewerContainer.style.display = 'none'; }

        async function forceDownload(url, filename) {
            try {
                const response = await fetch(url + "?t=" + Date.now());
                const blob = await response.blob();
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
            } catch (e) { window.open(url, '_blank'); }
        }

        function onSearch() {
            const k = searchInput.value.toLowerCase().replace(/-/g, '');
            if (!k) { if(mode==='home') renderHome(homeData); else renderFiles(currentFiles); return; }
            if (mode === 'home') {
                if (k.length >= 8) {
                    const targetMonth = k.substring(0,4) + '-' + k.substring(4,6);
                    const monthExists = homeData.find(m => m.name === targetMonth);
                    if (monthExists) { loadMonth(targetMonth, k); return; }
                }
                renderHome(homeData.filter(i => i.name.replace(/-/g, '').includes(k)));
            } else { renderFiles(currentFiles.filter(f => f.name.replace(/-/g, '').includes(k))); }
        }
        loadHome();
    </script>
</body>
</html>
