<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>æ€ªå°è‘µçš„å¼¹å¹•å½’æ¡£</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        :root { --pink: #ff69b4; --light-pink: #fff0f6; }
        body { font-family: -apple-system, sans-serif; background: #fdf2f5; margin: 0; padding: 15px; }
        .container { max-width: 500px; margin: 0 auto; background: white; border-radius: 24px; padding: 25px; box-shadow: 0 8px 30px rgba(255,105,180,0.1); min-height: 85vh; }
        .header { text-align: center; color: var(--pink); font-size: 1.6rem; font-weight: 800; margin-bottom: 25px; }
        .search-input { width: 100%; padding: 14px; border: 2px solid var(--light-pink); border-radius: 14px; margin-bottom: 20px; box-sizing: border-box; outline: none; width: 100%; }
        .card { display: flex; align-items: center; padding: 18px; background: #fff; border: 1px solid #f0f0f0; border-radius: 18px; cursor: pointer; transition: 0.2s; margin-bottom: 12px; }
        .card:hover { border-color: var(--pink); background: var(--light-pink); }
        .card-icon { font-size: 1.5rem; margin-right: 12px; }
        .card-name { flex: 1; font-weight: 700; color: #444; }
        .btn-down { padding: 8px 15px; border-radius: 12px; background: var(--pink); color: white; border: none; font-weight: bold; cursor: pointer; }
        .btn-back { background: #444; color: white; border: none; padding: 10px 20px; border-radius: 12px; margin-bottom: 15px; cursor: pointer; font-weight: bold; }
        #viewer-container { display: none; margin-bottom: 20px; }
        #viewer-content { background: #1a1a1a; color: #eee; padding: 18px; border-radius: 18px; white-space: pre-wrap; word-wrap: break-word; font-family: monospace; font-size: 0.9rem; max-height: 50vh; overflow-y: auto; line-height: 1.5; }
        .loading { text-align: center; padding: 40px; color: var(--pink); font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">ğŸŒ» æ€ªå°è‘µçš„å¼¹å¹•å½’æ¡£</div>
        <input type="text" id="search" class="search-input" placeholder="ğŸ” æœç´¢æœˆä»½æˆ–æ—¥æœŸ..." oninput="onSearch()">
        
        <div id="viewer-container">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <span id="viewing-name" style="color:var(--pink); font-weight:bold;">æ­£åœ¨é˜…è¯»</span>
                <button onclick="document.getElementById('viewer-container').style.display='none'" style="background:none; border:1px solid var(--pink); color:var(--pink); padding:4px 10px; border-radius:8px; cursor:pointer;">æ”¶èµ· â†‘</button>
            </div>
            <pre id="viewer-content"></pre>
        </div>

        <div id="content"></div>
    </div>

    <script>
        const user = "Sircatx";
        const repo = "3282568_danmu";
        // ä½¿ç”¨é’ˆå¯¹ Gitee/GitHub ä¼˜åŒ–çš„ jsDelivr é€šé“ï¼Œå›½å†…é€Ÿåº¦æå¿«ä¸”æ— è·¨åŸŸé™åˆ¶
        const fastProxy = "https://fastly.jsdelivr.net/gh/"; 
        const contentDiv = document.getElementById('content');
        let homeData = [], currentFiles = [], mode = 'home', currentMonth = '';

        async function loadHome() {
            mode = 'home';
            contentDiv.innerHTML = '<div class="loading">âœ¨ æ­£åœ¨è¿æ¥å›½å†…åŠ é€Ÿé€šé“...</div>';
            try {
                // ä¾ç„¶ä» GitHub è·å–ç›®å½•ç´¢å¼•ï¼Œå› ä¸ºå®ƒæœ€å‡†ç¡®
                const res = await fetch(`https://api.github.com/repos/${user}/${repo}/contents/?t=${Date.now()}`);
                const data = await res.json();
                homeData = data.filter(i => /^\d{4}-\d{2}$/.test(i.name)).reverse();
                renderHome(homeData);
            } catch (e) { contentDiv.innerHTML = '<div class="loading">âš ï¸ çº¿è·¯ç¹å¿™ï¼Œè¯·ç¨åå†è¯•</div>'; }
        }

        function renderHome(list) {
            let html = '';
            list.forEach(item => {
                html += `<div class="card" onclick="loadMonth('${item.name}')"><span class="card-icon">ğŸ“‚</span><span class="card-name">${item.name}</span><span>â”</span></div>`;
            });
            contentDiv.innerHTML = html;
        }

        async function loadMonth(m) {
            mode = 'files'; currentMonth = m;
            contentDiv.innerHTML = '<button class="btn-back" onclick="loadHome()">â¬… è¿”å›ä¸»é¡µ</button><div class="loading">æ­£åœ¨è¯»å–...</div>';
            try {
                const res = await fetch(`https://api.github.com/repos/${user}/${repo}/contents/${m}?t=${Date.now()}`);
                currentFiles = (await res.json()).filter(f => f.name.endsWith('.txt')).reverse();
                renderFiles(currentFiles);
            } catch (e) { contentDiv.innerHTML = 'åŠ è½½å¤±è´¥'; }
        }

        function renderFiles(files) {
            let html = '<button class="btn-back" onclick="loadHome()">â¬… è¿”å›ä¸»é¡µ</button>';
            files.forEach(f => {
                const fileUrl = `${fastProxy}${user}/${repo}@main/${currentMonth}/${f.name}`;
                html += `<div class="card" onclick="openFile('${fileUrl}', '${f.name}')">
                    <span class="card-icon">ğŸ“„</span>
                    <span class="card-name">${f.name.replace('.txt','')}</span>
                    <button class="btn-down" onclick="event.stopPropagation(); window.open('${fileUrl}')">ä¸‹è½½</button>
                </div>`;
            });
            contentDiv.innerHTML = html;
        }

        async function openFile(url, name) {
            const viewer = document.getElementById('viewer-container');
            const vContent = document.getElementById('viewer-content');
            document.getElementById('viewing-name').innerText = "å®æ—¶æŸ¥çœ‹ï¼š" + name.replace('.txt','');
            viewer.style.display = 'block';
            vContent.innerText = "ğŸš€ æ­£åœ¨ç§’é€Ÿæ‹‰å–æœ€æ–°å†…å®¹...";
            window.scrollTo({top: 0, behavior: 'smooth'});
            
            try {
                // å¢åŠ éšæœºæ•°é¿å¼€ç¼“å­˜ï¼Œç¡®ä¿â€œå†…å®¹å˜å¤šâ€
                const res = await fetch(url + "?v=" + Date.now());
                if (res.ok) {
                    vContent.innerText = await res.text();
                } else { throw new Error(); }
            } catch (e) {
                vContent.innerText = "âŒ è¯»å–å¤±è´¥ã€‚è¯·ç‚¹å‡»ä¸‹æ–¹çš„â€œä¸‹è½½â€æŒ‰é’®ç›´æ¥æŸ¥çœ‹ï¼Œæˆ–ç¨åå†è¯•ã€‚";
            }
        }

        function onSearch() {
            const k = document.getElementById('search').value.toLowerCase();
            if (mode === 'home') {
                renderHome(homeData.filter(i => i.name.includes(k)));
            } else {
                renderFiles(currentFiles.filter(f => f.name.includes(k)));
            }
        }

        loadHome();
    </script>
</body>
</html>
